<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="partials :: head"></head>
<title th:text="${user.getFirstName} + '\'s Profile'"></title>
<link rel="icon" href="../static/images/stir-fry.png" th:href="@{../images/stir-fry.png}">
<body style="background-color: #f2f2f2;">
<nav th:replace="partials :: navbar"></nav>

<section style="background-color: #f2f2f2;" class="vh-100">
    <div class="h-100 ps-5 pe-5 pt-4 pb-4">
        <!-- Profile Header Section -->
        <div class="row vh-25">
            <div class="col-md-5 col-lg-4">

                <img src="../static/images/pizzaman.jpg" th:src="@{../images/pizzaman.jpg}" id="user-img"
                     class="img-fluid"
                     alt="Person tossing pizza dough"/>
            </div>

            <div id="user-details" class="col-md-7 col-lg-8 p-3">
                <h1 id="fullname" class="header" th:text="${user.getFirstName()} + ' ' + ${user.getLastName()}">Gustav
                    Pizzamani</h1>
                <a th:href="@{'/follow/' + ${user.getId()}}"><img src="../static/images/add-friend.png"
                                                                  th:src="@{../images/add-friend.png}" id="add-friend"
                                                                  class="ms-3" alt="Add friend button"/></a>
                <!-- TODO: Dynamic follow / unfollow button -->
                <th:block sec:authorize="isAuthenticated()">
                    <th:block th:if="${isNotFollowing}">
                    <a th:href="@{'/follow/' + ${user.getId()}}"><img src="../static/images/follow.png" th:src="@{../images/follow.png}" id="add-friend" class="ms-3" alt="Add friend button" /></a>
                    </th:block>
                    <th:block th:if="${isFollowing}">
                        <a th:href="@{'/unfollow/' + ${user.getId()}}"><img src="../static/images/unfollow.png" th:src="@{../images/unfollow.png}" id="add-friend" class="ms-3" alt="Add friend button" /></a>
                    </th:block>
                    <th:block th:if="${showEditProfile}">
                        <button id="edit-profile-button" class="btn btn-danger align-self-center" style="height: 45px;">Edit Profile</button>
                    </th:block>
                </th:block>

                <div id="edit-profile-modal" class="modal">
                    <div class="modal-content">
                            <span class="close">&times;</span>
                            <h2 class="editYourProfile">Edit your profile!</h2>
                        <form id="edit-profile-form" th:action="@{/profile}" th:method="post" th:object="${user}"
                              class="mx-1 mx-md-4">
                            <div class="modal-container mt-3">
                                <div class="row mb-4">
                                    <div class="file-upload-placeholder col-md-4 col-sm-12">
                                        <input class="file-upload-input" type='file' onchange="readURL(this);"
                                               accept="image/*"/>
                                        <div id="img-upload">
                                            <img src="../static/images/photo.png" th:src="@{../images/photo.png}"
                                                 class="img-fluid file-upload-image" alt="Photo upload image"/>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="col-md-12">
                                            <label class="firstName" for="first-name">First Name:</label>
                                            <input type="text" id="first-name" class="form-control"
                                                   th:field="*{firstName}"
                                                   placeholder="First name" aria-label="First name">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="lastName" for="last-name">Last Name:</label>
                                            <input type="text" id="last-name" class="form-control"
                                                   th:field="*{lastName}"
                                                   placeholder="Last name" aria-label="Last name">
                                        </div>
                                        <div class="col-md-12">
                                            <label class="bio" for="bio">Bio:</label>
                                            <textarea id="bio" class="form-control" name="bio"
                                                      placeholder="Tell us about yourself!" aria-label="Bio"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center mx-4 mb-2 mb-lg-4">
                                <button id="saveChangesBtn" type="submit" class="btn btn-danger btn-lg">Save your changes</button>
                            </div>
                            <div class="d-flex justify-content-center mb-4"></div>
                        </form>
                    </div>
                </div>

                <h2 id="username" class="header" th:text="'@' + ${user.getUsername()}">@pizzaguy</h2>
                <p id="user-bio" class="pt-2 pb-2 h-50">
                    Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean
                    massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec
                    quam felis, ultricies nec,.
                </p>
                <ul id="user-stats" class="nav justify-content-between">
                    <li class="nav-item">
                        <span id="num-followers" th:text="${user.getFollowing().size()}">100</span> Followers
                    </li>
                    <li class="nav-item">
                        <span id="num-following" th:text="${user.getUserFollows().size()}">100</span> Following
                    </li>
                    <li class="nav-item">
                        <span id="num-recipes" th:text="${user.getCustom_recipes().size()}">34</span> Recipes
                    </li>
                </ul>
            </div>
        </div>

        <!-- Profile Tabs -->
        <div id="profile-tabs" class="row mt-4 mb-3" role="tablist">
            <div class="col-4 pe-1">
                <button type="button" id="activity-btn" class="btn btn-lg btn-secondary w-100" role="tab" data-bs-toggle="pill" data-bs-target="#user-activity" aria-controls="user-activity" aria-selected="false">Activity</button>
            </div>
            <div class="col-4">
                <button type="button" id="recipes-btn" class="btn btn-lg btn-secondary w-100 active" role="tab" data-bs-toggle="pill" data-bs-target="#user-recipes" aria-controls="user-recipes" aria-selected="true">Recipes</button>
            </div>
            <div class="col-4 ps-1">
                <button type="button" id="chapters-btn" class="btn btn-lg btn-secondary w-100" role="tab" data-bs-toggle="pill" data-bs-target="#user-chapters" aria-controls="user-chapters" aria-selected="false">Saved</button>

            </div>
        </div>

        <!-- Profile Body Section -->
        <div class="row tab-content">
            <div id="user-activity" class="tab-pane fade" role="tabpanel" aria-labelledby="activity-btn" tabindex="0">
                <h1 class="header">Recent Activity</h1>
                <hr>
                <!-- Content Here -->
            </div>

            <div id="user-recipes" class="tab-pane fade show active" role="tabpanel" aria-labelledby="recipes-btn" tabindex="0">
                <h1 class="header">User Recipes</h1>
                <hr>
                <!-- User Recipe Cards -->
                <!-- TODO: Fix card spacing -->
                <div id="recipe-content" class="d-flex flex-wrap flex-row justify-content-between">
                    <div th:each="recipe : ${recipes}" class="m-0 p-0">
                        <div th:replace="partials :: recipe-card(
                            id = ${recipe.getRecipe().getId()},
                            image = ${recipe.getRecipe().getImage()},
                            title = ${recipe.getRecipe().getTitle()},
                            username = ${user.getUsername()},
                            userimg = ${user.getProfilePicture()},
                            firstname = ${user.getFirstName()},
                            lastname = ${user.getLastName()},
                            date = ${recipe.getRecipe().getCreatedAt()},
                            reviews = ${recipe.getRecipe().getReviews().size},
                            saves = ${recipeDao.getNumberOfSavesByRecipeId(recipe.getRecipe().getId())})">
                        </div>
                    </div>
                </div>
            </div>

            <div id="user-chapters" class="tab-pane fade" role="tabpanel" aria-labelledby="chapters-btn" tabindex="0">
                <h1 class="header">Saved Recipes</h1>
                <hr>
                <!-- Saved Recipe Cards -->
                <!-- TODO: Fix card spacing -->
                <div id="saved-content" class="d-flex flex-wrap flex-row justify-content-between">
                    <div th:each="recipe : ${savedRecipes}" class="m-0 p-0">
                        <div th:replace="partials :: recipe-card(
                            id = ${recipe.getId()},
                            image = ${recipe.getImage()},
                            title = ${recipe.getTitle()},
                            username = ${user.getUsername()},
                            userimg = ${user.getProfilePicture()},
                            firstname = ${user.getFirstName()},
                            lastname = ${user.getLastName()},
                            date = ${recipe.getCreatedAt()},
                            reviews = ${recipe.getReviews().size},
                            saves = ${recipeDao.getNumberOfSavesByRecipeId(recipe.getId())})">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div th:replace="partials :: script"></div>
<script>
    const editProfileButton = document.getElementById('edit-profile-button');
    const modal = document.getElementById('edit-profile-modal');
    const closeButton = document.getElementsByClassName('close')[0];
    const editProfileForm = document.getElementById('edit-profile-form');
    const saveChanges = document.getElementById("saveChangesBtn");

    editProfileButton.addEventListener('click', () => {
        modal.style.display = 'block';
    });

    closeButton.addEventListener('click', () => {
        modal.style.display = 'none';
    });


    window.addEventListener('click', (event) => {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
    saveChanges.addEventListener('click', (event) => {
        modal.style.display = 'none';
    });
</script>
</body>
</html>
