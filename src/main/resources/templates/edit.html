<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="partials :: head"></head>
<title>Edit Recipe</title>
<body style="background-color: #f2f2f2;">
<nav th:replace="partials :: navbar"></nav>

<section style="background-color: #f2f2f2;">
  <form id="edit-recipe-form" th:action="@{/recipe/edit}" th:method="post">
    <div class="row ms-5 me-5 ps-5 pe-5 pt-4 pb-4">
      <!-- RECIPE DETAILS -->
      <input type="hidden" th:name="id" th:value="${recipe.getRecipe().getId()}">
      <div id="edit-recipe-details" class="row mb-3">
        <div class="col">
          <h1 class="header">Recipe Details</h1>
        </div>
        <div class="col d-flex justify-content-end align-items-center">
          <a th:href="@{'/recipe/' + ${recipe.getRecipe().getId()} + '/delete'}">
            <i class="fa-regular fa-trash-can pb-2"></i>
          </a>
        </div>
        <hr>
        <div class="col-md-8 col-12">
          <div class="form-floating mb-2">
            <input type="text" th:name="title" th:value="${recipe.getRecipe().title}" class="form-control" id="edit-recipe-title" placeholder="Recipe Title" required>
            <label for="edit-recipe-title">Recipe Title</label>
          </div>
          <div class="form-floating mb-2">
            <textarea th:name="description" th:text="${recipe.summary}" class="form-control" id="edit-recipe-description" placeholder="Recipe Description" rows="5" style="height: 150px;" required></textarea>
            <label for="edit-recipe-description">Recipe Description</label>
          </div>
          <div class="row">
            <div class="col-4 pe-1">
              <div class="form-floating mb-2">
                <input th:name="time" th:value="${recipe.readyInMinutes}" type="number" class="form-control" id="edit-recipe-time" placeholder="Prep Time" required>
                <label for="edit-recipe-time">Prep Time (minutes)</label>
              </div>
            </div>
            <div class="col-4">
              <div class="form-floating mb-2">
                <input th:name="servings" th:value="${recipe.servings}" type="number" class="form-control" id="edit-recipe-servings" placeholder="Servings" required>
                <label for="edit-recipe-servings">Servings</label>
              </div>
            </div>
            <div class="col-4 ps-1">
              <!-- TODO: Use thymeleaf to populate options -->
              <div class="mb-2">
                <select th:name="category" class="form-select" id="edit-recipe-category" aria-label="Category" style="height: 58px;" required>
                  <option value="1" th:selected="${recipe.getRecipe().dishTypes[0].type == 'main course'}">Main Course</option>
                  <option value="2" th:selected="${recipe.getRecipe().dishTypes[0].type == 'side dish'}">Side Dish</option>
                  <option value="4" th:selected="${recipe.getRecipe().dishTypes[0].type == 'appetizer'}">Appetizer</option>
                  <option value="6" th:selected="${recipe.getRecipe().dishTypes[0].type == 'bread'}">Bread</option>
                  <option value="8" th:selected="${recipe.getRecipe().dishTypes[0].type == 'soup'}">Soup</option>
                  <option value="5" th:selected="${recipe.getRecipe().dishTypes[0].type == 'salad'}">Salad</option>
                  <option value="7" th:selected="${recipe.getRecipe().dishTypes[0].type == 'breakfast'}">Breakfast</option>
                  <option value="3" th:selected="${recipe.getRecipe().dishTypes[0].type == 'dessert'}">Dessert</option>
                  <option value="10" th:selected="${recipe.getRecipe().dishTypes[0].type == 'sauce'}">Sauce</option>
                  <option value="9" th:selected="${recipe.getRecipe().dishTypes[0].type == 'beverage'}">Beverage</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="file-upload-placeholder col-md-4 col-sm-12">
          <div id="img-upload">
            <img th:src="${recipe.getRecipe().getImage()}" src="" class="img-fluid file-upload-image" alt="Photo upload image" id="recipeImage"/>
          </div>
          <input type="hidden" th:value="${recipe.getRecipe().getImage()}" id="fileStackResponse" th:name="imageURL">
        </div>
      </div>
      <!-- RECIPE INGREDIENTS -->
      <th:block>
        <div id="edit-recipe-ingredients" class="row mb-3">
          <div class="col">
            <h1 class="header">Ingredients</h1>
          </div>
          <div class="col d-flex justify-content-end align-items-center">
            <button type="button" id="add-ing-btn" class="btn btn-sm btn-danger justify-self-end">
              Add Ingredient
            </button>
          </div>
          <hr>
          <div class="row">
            <div class="col-7 d-flex justify-content-center">
              <h5 class="">Ingredients</h5>
            </div>
            <div class="col d-flex justify-content-center">
              <h5>Quantity</h5>
            </div>
            <div class="col d-flex justify-content-center">
              <h5>Unit</h5>
            </div>
          </div>
          <ol th:object="${ingredients}" id="ingredients" th:attr="data-num=${recipe.getIngredients().size()}">
            <th:block th:each="ingredient, iter : ${ingredients.getIngredients()}">
              <li th:id="'ing-' + ${iter.index + 1}">
                <div class="row g-3 mb-1">
                  <div class="col-sm-7">
                    <input type="text" class="form-control" placeholder="e.g. eggs, beat" aria-label="Ingredient Name" th:name="'ingredients[' + ${iter.index} + '].name'" th:value="${ingredient.name}" required>
                  </div>
                  <div class="col-sm">
                    <input type="number" step="0.1" class="form-control" placeholder="Quantity" aria-label="Quantity" th:name="'ingredients[' + ${iter.index} + '].amount'" th:value="${ingredient.amount}" required>
                  </div>
                  <div class="col-sm">
                    <select class="form-select" aria-label="Unit" th:name="'ingredients[' + ${iter.index} + '].unit'" th:value="${ingredient.unit}">
                      <option value="" th:selected="${ingredient.unit == null}">--</option>
                      <option value="tbsp" th:selected="${ingredient.unit == 'tbsp'}">tbsp</option>
                      <option value="tsp" th:selected="${ingredient.unit == 'tsp'}">tsp</option>
                      <option value="cup(s)" th:selected="${ingredient.unit == 'cup(s)'}">cup(s)</option>
                      <option value="quart(s)" th:selected="${ingredient.unit == 'quart(s)'}">quart(s)</option>
                      <option value="pint(s)" th:selected="${ingredient.unit == 'pint(s)'}">pint(s)</option>
                      <option value="gallon(s)" th:selected="${ingredient.unit == 'gallon(s)'}">gallon(s)</option>
                      <option value="oz" th:selected="${ingredient.unit == 'oz'}">oz</option>
                      <option value="floz" th:selected="${ingredient.unit == 'floz'}">fl oz</option>
                      <option value="pound(s)" th:selected="${ingredient.unit == 'pound(s)'}">pound(s)</option>
                      <option value="milliliter(s)" th:selected="${ingredient.unit == 'milliliter(s)'}">milliliter(s)</option>
                      <option value="liter(s)" th:selected="${ingredient.unit == 'liter(s)'}">liter(s)</option>
                      <option value="gram(s)" th:selected="${ingredient.unit == 'gram(s)'}">gram(s)</option>
                      <option value="kilogram(s)" th:selected="${ingredient.unit == 'kilogram(s)'}">kilogram(s)</option>
                      <option value="whole" th:selected="${ingredient.unit == 'whole'}">whole</option>
                      <option value="pinch" th:selected="${ingredient.unit == 'pinch(es)'}">pinch(es)</option>
                      <option value="serving(s)" th:selected="${ingredient.unit == 'serving(s)'}">serving(s)</option>
                    </select>
                  </div>
                </div>
              </li>
            </th:block>
          </ol>
        </div>
      </th:block>
      <th:block>
        <!-- RECIPE INSTRUCTIONS -->
        <div id="create-recipe-instructions" class="row">
          <div class="col">
            <h1 class="header">Instructions</h1>
          </div>
          <div class="col d-flex justify-content-end align-items-center">
            <button type="button" id="add-ins-btn" class="btn btn-sm btn-danger justify-self-end">
              Add Step
            </button>
          </div>
          <hr>
          <ol th:object="${instructions}" id="instructions" th:attr="data-num=${recipe.getInstructions().size()}">
            <th:block th:each="instruction, iter : ${instructions.getInstructions()}">
              <li th:id="'ins-' + ${iter.index + 1}">
                <div class="mb-1">
                  <input type="hidden" value="" th:name="'instructions[' + ${iter.index} + '].order_num'" th:value="${instruction.order_num}">
                  <textarea maxlength="500" th:name="'instructions[' + ${iter.index} + '].content'" th:value="${instruction.content}" th:text="${instruction.content}" class="form-control" placeholder="Recipe Instructions" rows="2" required></textarea>
                </div>
              </li>
            </th:block>
          </ol>
        </div>
      </th:block>
      <div class="d-flex justify-content-center align-items-center">
        <button type="submit" class="btn btn-lg btn-danger col-2">Submit</button>
      </div>
    </div>
  </form>
</section>

<div th:replace="partials :: script"></div>
<script src="//static.filestackapi.com/filestack-js/3.x.x/filestack.min.js"></script>
<script th:inline="javascript">

  // Controls the file uploader
  const client = filestack.init([[${filestack}]]);
  const options = {
    onFileUploadFinished(file) {
      console.log(file);
      $('#fileStackResponse').val(file.url)
      $('#recipeImage').attr('src', file.url).removeData('th:src')
    }
  }

  $(`#img-upload`).click(function(){
    client.picker(options).open();
  });

  // Add Ingredient Functionality
  function addIngredient(num) {
    let html = '';

    if (num < 10) {
      num++;

      html += `
                <li id="ing-${num}">
                        <div class="row g-3 mb-1">
                            <div class="col-sm-7">
                                <input type="text" class="form-control" placeholder="e.g. eggs, beat" aria-label="Ingredient Name" name="ingredients[${num - 1}].name" value="" required>
                            </div>
                            <div class="col-sm">
                                <input type="number" class="form-control" placeholder="Quantity" aria-label="Quantity" name="ingredients[${num - 1}].amount" value="0.0" required>
                            </div>
                            <div class="col-sm">
                                <select class="form-select" aria-label="Unit" name="ingredients[${num - 1}].unit">
                                    <option value="">--</option>
                                    <option value="tbsp">tbsp</option>
                                    <option value="tsp">tsp</option>
                                    <option value="cup(s)">cup(s)</option>
                                    <option value="quart(s)">quart(s)</option>
                                    <option value="pint(s)">pint(s)</option>
                                    <option value="gallon(s)">gallon(s)</option>
                                    <option value="oz">oz</option>
                                    <option value="floz">fl oz</option>
                                    <option value="pound(s)">pound(s)</option>
                                    <option value="milliliter(s)">milliliter(s)</option>
                                    <option value="liter(s)">liter(s)</option>
                                    <option value="gram(s)">gram(s)</option>
                                    <option value="kilogram(s)">kilogram(s)</option>
                                    <option value="whole">whole</option>
                                    <option value="pinch">pinch(es)</option>
                                    <option value="serving(s)">serving(s)</option>
                                </select>
                            </div>
                        </div>
                    </li>`;

      $(`#ing-${num - 1}`).after(html);
    }

    $(`#ingredients`).attr('data-num', num);

  }

  $('#add-ing-btn').click((event) => {
    let total = $('#ingredients').attr('data-num');
    addIngredient(total);
  });

  // Add Instruction Functionality
  function addInstruction(num) {
    let html = '';

    if (num < 10) {
      num++;

      html += `
                <li id="ins-${num}">
                        <div class="mb-1">
                            <input type="hidden" value="1" name="instructions[${num - 1}].order_num">
                            <textarea name="instructions[${num - 1}].content" class="form-control" placeholder="Recipe Instructions" id="create-recipe-step-1" rows="2" required></textarea>
                        </div>
                </li>`;

      $(`#ins-${num - 1}`).after(html);
    }

    $(`#instructions`).attr('data-num', num);

  }

  $('#add-ins-btn').click((event) => {
    let total = $('#instructions').attr('data-num');
    addInstruction(total);
  });

</script>

</body>
</html>